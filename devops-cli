#!/bin/bash

# devops-cli - Unified DevOps Operations CLI Tool
# Version: 1.0.0

set -euo pipefail

# Script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Source libraries
source "$SCRIPT_DIR/lib/helpers.sh"
source "$SCRIPT_DIR/lib/logger.sh"
source "$SCRIPT_DIR/lib/config.sh"

# Source modules
source "$SCRIPT_DIR/modules/server.sh"
source "$SCRIPT_DIR/modules/deploy.sh"
source "$SCRIPT_DIR/modules/backup.sh"
source "$SCRIPT_DIR/modules/monitor.sh"
source "$SCRIPT_DIR/modules/logs.sh"

# Version
readonly VERSION="1.0.0"

# Show main help
show_help() {
    cat << 'EOF'
DevOps CLI - Unified DevOps Operations Tool

Usage: devops-cli <command> [subcommand] [options]

COMMANDS:
    server      Server management (start, stop, restart, status, list)
    deploy      Deployment operations (app, rollback, status, list)
    backup      Backup management (create, restore, list, delete)
    monitor     System monitoring (cpu, memory, disk, network, services)
    logs        Log management (view, tail, search, rotate, clean)
    config      Configuration management (show, set, reset, validate)

GLOBAL OPTIONS:
    -h, --help     Show this help message
    -v, --version  Show version information
    --debug        Enable debug logging

EXAMPLES:
    devops-cli server start nginx
    devops-cli deploy app myapp /path/to/source
    devops-cli backup create mydb /var/lib/mysql
    devops-cli monitor cpu --watch
    devops-cli logs view

For command-specific help, use:
    devops-cli <command> --help

CONFIGURATION:
    Config file: ~/.devops-cli/config
    Log file: ~/.devops-cli/logs/devops-cli.log

For more information, see COMMANDS.md
EOF
}

# Show version
show_version() {
    echo "DevOps CLI version $VERSION"
}

# Handle config command
handle_config_command() {
    local subcommand="$1"
    shift || true
    
    case "$subcommand" in
        show)
            show_config
            ;;
        set)
            if [[ $# -lt 2 ]]; then
                die "Usage: devops-cli config set <key> <value>" 1
            fi
            set_config "$1" "$2"
            ;;
        reset)
            reset_config
            ;;
        validate)
            validate_config
            ;;
        edit)
            local editor="${EDITOR:-nano}"
            $editor "$(get_config_file)"
            ;;
        -h|--help|help|"")
            cat << 'EOF'
Usage: devops-cli config <subcommand>

Configuration management commands

SUBCOMMANDS:
    show        Show current configuration
    set         Set configuration value
    reset       Reset to default configuration
    validate    Validate configuration
    edit        Edit configuration file

EXAMPLES:
    devops-cli config show
    devops-cli config set log_level DEBUG
    devops-cli config validate
EOF
            ;;
        *)
            print_error "Unknown config subcommand: $subcommand"
            exit 1
            ;;
    esac
}

# Main function
main() {
    # Initialize systems
    init_logging
    init_config
    
    # Parse global options
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -h|--help)
                show_help
                exit 0
                ;;
            -v|--version)
                show_version
                exit 0
                ;;
            --debug)
                set_log_level "DEBUG"
                shift
                ;;
            -*)
                print_error "Unknown option: $1"
                echo ""
                show_help
                exit 1
                ;;
            *)
                break
                ;;
        esac
    done
    
    # Get command
    local command="${1:-}"
    
    if [[ -z "$command" ]]; then
        show_help
        exit 0
    fi
    
    shift
    
    # Set log level from config
    set_log_level "$(get_config 'log_level')"
    
    # Route to appropriate command handler
    case "$command" in
        server)
            handle_server_command "$@"
            ;;
        deploy)
            handle_deploy_command "$@"
            ;;
        backup)
            handle_backup_command "$@"
            ;;
        monitor)
            handle_monitor_command "$@"
            ;;
        logs)
            handle_logs_command "$@"
            ;;
        config)
            handle_config_command "$@"
            ;;
        help)
            show_help
            ;;
        *)
            print_error "Unknown command: $command"
            echo ""
            show_help
            exit 1
            ;;
    esac
}

# Run main function
main "$@"
